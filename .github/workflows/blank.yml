name: Cloudflare IP ä¼˜é€‰æµ‹é€Ÿ

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ™šä¸Š4ç‚¹ (UTC 12:00)
    - cron: '0 20 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º Release

jobs:
  speedtest:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º2å°æ—¶
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python çŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install requests
        
    - name: è¿è¡Œè‡ªåŠ¨åŒ–æµ‹é€Ÿè„šæœ¬
      run: |
        python3 auto_speedtest.py
        
    - name: æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "=== ip.txt å†…å®¹é¢„è§ˆ ==="
        if [ -f ip.txt ]; then
          wc -l ip.txt
          echo ""
          head -20 ip.txt
        else
          echo "ip.txt æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "=== pyip.txt å†…å®¹é¢„è§ˆ ==="
        if [ -f pyip.txt ]; then
          wc -l pyip.txt
          echo ""
          head -20 pyip.txt
        else
          echo "pyip.txt æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
    - name: åˆ›å»º Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # èŽ·å–å½“å‰æ—¥æœŸ
        DATE=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M")
        TAG="auto-$(TZ=Asia/Shanghai date +"%Y%m%d-%H%M")"
        
        # ç»Ÿè®¡IPæ•°é‡
        IP_COUNT=0
        PYIP_COUNT=0
        if [ -f ip.txt ]; then
          IP_COUNT=$(grep -v '^#' ip.txt | grep -v '^$' | wc -l)
        fi
        if [ -f pyip.txt ]; then
          PYIP_COUNT=$(grep -v '^#' pyip.txt | grep -v '^$' | wc -l)
        fi
        
        # åˆ›å»º Release è¯´æ˜Ž
        cat > release_notes.md << EOFNOTES
        # ðŸš€ Cloudflare ä¼˜é€‰ IP è‡ªåŠ¨æ›´æ–°
        
        **æ›´æ–°æ—¶é—´**: ${DATE} (åŒ—äº¬æ—¶é—´)
        
        ## ðŸ“¦ æ–‡ä»¶è¯´æ˜Ž
        
        ### ðŸ“„ ip.txt (${IP_COUNT} ä¸ªIP)
        - **æ ¼å¼**: \`IP:ç«¯å£#å›½å®¶ä¸­æ–‡åç§°\`
        - **å†…å®¹**: ä¼˜é€‰çš„ Cloudflare IP åœ°å€
        - **æ¥æº**: é¦™æ¸¯ã€æ—¥æœ¬ã€éŸ©å›½ã€ç¾Žå›½ã€æ–°åŠ å¡äº”ä¸ªåœ°åŒºæµ‹é€Ÿç»“æžœ
        - **ç¤ºä¾‹**: 
          \`\`\`
          104.16.1.1:443#é¦™æ¸¯
          172.67.1.1:443#æ—¥æœ¬
          \`\`\`
        
        ### ðŸ“„ pyip.txt (${PYIP_COUNT} ä¸ªIP)
        - **æ ¼å¼**: \`IP:ç«¯å£#å›½å®¶ä¸­æ–‡åç§°\`
        - **å†…å®¹**: ä¼˜é€‰çš„åä»£ IP åœ°å€
        - **æ¥æº**: å¯¹ä¼˜é€‰IPè¿›è¡ŒäºŒæ¬¡æµ‹é€ŸéªŒè¯
        - **ç‰¹ç‚¹**: ç»è¿‡åŒé‡ç­›é€‰ï¼Œè´¨é‡æ›´ä¼˜
        
        ## ðŸ“Š æµ‹é€Ÿå‚æ•°
        
        | å‚æ•° | å€¼ |
        |------|-----|
        | æµ‹è¯•é…ç½® | **é«˜è´¨é‡æµ‹è¯•** |
        | IPæ•°é‡ | **50ä¸ª/åœ°åŒº** |
        | é€Ÿåº¦ä¸‹é™ | **5 MB/s** |
        | å»¶è¿Ÿä¸Šé™ | **200 ms** |
        | æµ‹è¯•åœ°åŒº | HKG, JPN, KOR, USA, SIN |
        
        ## ðŸš€ ä½¿ç”¨æ–¹æ³•
        
        ### æ–¹æ³•1ï¼šç›´æŽ¥ä¸‹è½½
        \`\`\`bash
        # ä¸‹è½½ä¼˜é€‰IP
        wget https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/ip.txt
        
        # ä¸‹è½½åä»£IP
        wget https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/pyip.txt
        \`\`\`
        
        ### æ–¹æ³•2ï¼šä½¿ç”¨æœ€æ–°ç‰ˆæœ¬é“¾æŽ¥
        \`\`\`
        ä¼˜é€‰IP: https://github.com/${GITHUB_REPOSITORY}/releases/latest/download/ip.txt
        åä»£IP: https://github.com/${GITHUB_REPOSITORY}/releases/latest/download/pyip.txt
        \`\`\`
        
        ### æ–¹æ³•3ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨
        
        #### Clash é…ç½®ç¤ºä¾‹
        \`\`\`yaml
        proxies:
          - name: "CF-HK-1"
            type: vmess
            server: 104.16.1.1
            port: 443
        \`\`\`
        
        #### V2Ray é…ç½®ç¤ºä¾‹
        \`\`\`json
        {
          "outbounds": [{
            "protocol": "vmess",
            "settings": {
              "vnext": [{
                "address": "104.16.1.1",
                "port": 443
              }]
            }
          }]
        }
        \`\`\`
        
        ## ðŸ“ æ³¨æ„äº‹é¡¹
        
        - â° æ¯å¤©åŒ—äº¬æ—¶é—´ 20:00 è‡ªåŠ¨æ›´æ–°
        - ðŸŒ IPè´¨é‡å¯èƒ½å› ç½‘ç»œçŽ¯å¢ƒè€Œå¼‚
        - ðŸ”„ å»ºè®®å®šæœŸæ›´æ–°ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
        - ðŸ“Š åä»£IP (pyip.txt) ç»è¿‡äºŒæ¬¡éªŒè¯ï¼ŒæŽ¨èä¼˜å…ˆä½¿ç”¨
        
        ## ðŸ“ˆ æ•°æ®ç»Ÿè®¡
        
        - ä¼˜é€‰IPæ€»æ•°: ${IP_COUNT}
        - åä»£IPæ€»æ•°: ${PYIP_COUNT}
        - æµ‹è¯•åœ°åŒº: 5ä¸ª
        - æµ‹è¯•æ€»æ—¶é•¿: çº¦15-30åˆ†é’Ÿ
        
        ---
        
        **ðŸ¤– è‡ªåŠ¨ç”Ÿæˆ**: ${DATE} | **ðŸ“¦ ç‰ˆæœ¬**: ${TAG}
        EOFNOTES
        
        # æ›¿æ¢å˜é‡
        sed -i "s|\${DATE}|${DATE}|g" release_notes.md
        sed -i "s|\${TAG}|${TAG}|g" release_notes.md
        sed -i "s|\${GITHUB_REPOSITORY}|${GITHUB_REPOSITORY}|g" release_notes.md
        sed -i "s|\${IP_COUNT}|${IP_COUNT}|g" release_notes.md
        sed -i "s|\${PYIP_COUNT}|${PYIP_COUNT}|g" release_notes.md
        
        # åˆ›å»º Release
        gh release create "${TAG}" \
          --title "âœ¨ ä¼˜é€‰IPæ›´æ–° ${DATE}" \
          --notes-file release_notes.md \
          ip.txt \
          pyip.txt \
          --repo "${GITHUB_REPOSITORY}"
          
    - name: æ¸…ç†æ—§ Release (ä¿ç•™æœ€è¿‘7ä¸ª)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
      run: |
        # ä¿ç•™æœ€è¿‘7ä¸ª Release
        gh release list --limit 100 --json tagName,createdAt \
          --jq '.[] | select(.tagName | startswith("auto-")) | .tagName' \
          | tail -n +8 \
          | while read tag; do
            echo "åˆ é™¤æ—§ç‰ˆæœ¬: $tag"
            gh release delete "$tag" --yes --cleanup-tag || true
          done
